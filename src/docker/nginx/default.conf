server {
  listen 80;
  server_name _;

  root  /var/www/html/public;
  index index.php;
  client_max_body_size 32m;

  # Laravel 公式の基本形：物理があれば配信、なければ Laravel へ
  location / { try_files $uri $uri/ /index.php?$query_string; }

  # Filament v4 の動的アセットは必ず PHP に渡す（静的優先より上で ^~）
  location ^~ /fonts/filament/ { try_files $uri /index.php?$query_string; }
  location ^~ /css/filament/   { try_files $uri /index.php?$query_string; }
  location ^~ /js/filament/    { try_files $uri /index.php?$query_string; }

  # Livewire も PHP 側で処理（/livewire/update 等）
  location ^~ /livewire/ { try_files $uri /index.php?$query_string; }

  # 通常の静的配信（Filament系は上の ^~ が優先される）
  location ~* \.(?:css|js|jpg|jpeg|gif|png|svg|ico|webp|avif|woff|woff2|ttf|otf)$ {
    access_log off;
    expires 30d;
    add_header Cache-Control "public, max-age=2592000, immutable";
    try_files $uri =404;
  }

  # PHP-FPM（keiba-app:9000）
  location ~ \.php$ {
    try_files $uri =404;  # public/ に存在する PHP だけ実行（通常 index.php）
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_param PATH_INFO $fastcgi_path_info;
    fastcgi_pass keiba-app:9000;
    fastcgi_read_timeout 300;
    fastcgi_buffers 8 16k;
    fastcgi_buffer_size 32k;
  }

  # 隠しファイルは拒否
  location ~ /\.(?!well-known).* { deny all; }
  location = /favicon.ico { log_not_found off; access_log off; }
  location = /robots.txt  { log_not_found off; access_log off; }
}
